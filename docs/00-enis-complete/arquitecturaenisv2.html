<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ENIS Architecture v3.0 - Production Ready</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/cytoscape/3.26.0/cytoscape.min.js"></script>
  <style>
    body{margin:0;padding:20px;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,"Helvetica Neue",Arial,"Noto Sans","Apple Color Emoji","Segoe UI Emoji";background:linear-gradient(135deg,#667eea 0%,#764ba2 100%)}
    .container{max-width:1800px;margin:0 auto;background:#fff;border-radius:20px;box-shadow:0 20px 60px rgba(0,0,0,.3);overflow:hidden}
    .header{background:linear-gradient(135deg,#1e3c72 0%,#2a5298 100%);color:#fff;padding:30px;text-align:center}
    .header h1{margin:0;font-size:2.2em;font-weight:600}
    .header p{margin:10px 0 0;opacity:.9}
    #cy{width:100%;height:1200px;background:linear-gradient(to bottom,#f8f9fa,#e9ecef)}
    .legend{padding:20px 30px;background:#fff;border-top:1px solid #e0e0e0}
    .legend h3{margin:0 0 15px;color:#333}
    .legend-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));gap:15px}
    .legend-section{background:#f8f9fa;padding:15px;border-radius:8px}
    .legend-section h4{margin:0 0 10px;color:#555;font-size:13px;text-transform:uppercase;letter-spacing:1px}
    .legend-item{display:flex;align-items:center;gap:10px;margin:6px 0;font-size:13px}
    .legend-color{width:22px;height:22px;border-radius:5px;border:2px solid #fff;box-shadow:0 2px 4px rgba(0,0,0,.1)}
    .legend-note{grid-column:1 / -1;background:#e9f7ef;border-left:4px solid #2ecc71;padding:12px;border-radius:8px;color:#2c3e50;font-size:13px}
    .controls{padding:16px 24px;background:#f8f9fa;display:flex;gap:10px;justify-content:center;flex-wrap:wrap}
    button{padding:10px 16px;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:#fff;border:none;border-radius:8px;cursor:pointer;font-size:14px;transition:.2s}
    button:hover{transform:translateY(-2px);box-shadow:0 6px 16px rgba(0,0,0,.18)}
    .info-panel{padding:18px 24px;background:#e3f2fd;border-left:4px solid #2196f3;margin:20px 24px;border-radius:8px}
    .info-panel h3{margin:0 0 8px;color:#1976d2}
    .policy-box{background:#fff3e0;padding:14px;margin:20px 24px;border-radius:8px;border-left:4px solid #ff9800;font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;font-size:12px;line-height:1.5}
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>🚀 ENIS v3.0 — Enterprise Neural Intelligence Systems</h1>
      <p>Arquitectura Production-Ready: Edge-First + Cloud Intelligence + Data Sovereignty</p>
    </div>

    <div class="info-panel">
      <h3>🔐 Principios de Seguridad y Data Sovereignty</h3>
      <p><b>Edge (Cliente):</b> NOPS Kernel + Edge Agents + Event Bus (Redis Streams)</p>
      <p><b>Cloud (ENIS):</b> Inference Service + Macro-módulos + 7 Módulos NOPS + 2 Interfaces Avanzadas + Marketplace</p>
      <p><b>Data Policy:</b> Los datos crudos <u>no</u> salen del cliente. Solo viajan <i>features/vectores minimizados</i> según política (PII redaction + minimization obligatoria).</p>
      <p><b>Security por Canal:</b></p>
      <ul style="margin:8px 0;padding-left:20px;line-height:1.6">
        <li>🟤🟡🟢 Zero/Shared/Lite → Kernel: <b>API Keys + TLS 1.3</b></li>
        <li>🔵🔴 Enterprise/Air-Gap → Kernel: <b>mTLS + Certificate Auth</b></li>
        <li>Kernel ↔ Cloud: <b>mTLS + JWT s2s</b> + scoped endpoints</li>
        <li>Users → Sistema: <b>JWT + RBAC/ABAC</b> + MFA (tier 3)</li>
        <li>Audit Trail: <b>Mandatory + immutable</b> en TODOS los canales</li>
        <li>🔐 <b>SEC (Signed Execution Contract)</b>: Firma criptográfica + validación de binarios/contenedores + SBOM + Audit Trail (S13.5 - <b>CRÍTICO para GA</b>)</li>
      </ul>
      <p style="margin-top:8px;font-size:0.9em;opacity:0.85"><i>Estado: JWT ✅, RBAC ✅, API Keys básico ✅ | En desarrollo: API Keys Rotation (S11), mTLS Everywhere (S13), <b>SEC Supply Chain (S13.5)</b></i></p>
    </div>

    <div class="info-panel" style="background:#f0f8ff;border-left-color:#4169e1;">
      <h3>🎤🥽 Nuevas Interfaces Avanzadas (Q2-Q3 2025)</h3>
      <p><b>Voice Interface Service:</b> Procesamiento de voz en tiempo real con TTFT < 300ms, bargein < 100ms. Integra STT/VAD/TTS con múltiples providers (Whisper, Google STT, webrtcvad, Silero).</p>
      <p><b>XR Interface Service:</b> Soporte para Meta Quest 3, Apple Vision Pro, HoloLens 2. Streaming 30Hz con jitter < 50ms, fusión multimodal (mano + gaze + voz), spatial mapping y gesture recognition.</p>
      <p><b>Integración:</b> Ambos servicios se conectan directamente con Inference Service y Studio App, proporcionando capacidades únicas en el mercado empresarial.</p>
    </div>

    <div class="policy-box" style="background:#e8f5e9;border-left-color:#4caf50;">
      <strong>📁 Organización de Repositorios ENIS v3.0:</strong><br/>
      <b>cloud-core/</b> (15 repos): asm, awe, cgn, inference, shif + <b>7 módulos NOPS</b> (observability, scorecard, billing, sandbox, resource-governance ✅, lifecycle, compliance) + <b>2 interfaces avanzadas</b> (voice-interface, xr-interface) + <b>1 governance</b> (data-governance DGE)<br/>
      <b>cloud-ops/</b> (1 repo): cloud-infrastructure<br/>
      <b>edge/</b> (3 repos): nops-kernel, edge-agents, edge-infrastructure<br/>
      <b>platform/</b> (2 repos): agent-marketplace, enis-frontend<br/>
      <b>shared/</b> (3 repos): agent-contracts, agent-sdks, enis-infrastructure<br/>
      <strong>Total:</strong> 24 repositorios independientes + docs/
    </div>

    <div class="policy-box">
      <strong>data_egress_policy:</strong><br/>
      raw_data: "forbidden"<br/>
      derived_signals: "allow_if_policy"<br/>
      requires: [pii_redaction: true, minimization: true, tenant_scoped: true, mTLS: true, s2s_scopes: ["inference.execute","marketplace.sync"] ]<br/>
      rate_limits: { per_tenant: "enforced", per_agent: "enforced" }<br/>
      audit_log: "mandatory"
    </div>

    <div class="controls">
      <button onclick="resetView()">🔄 Reset Vista</button>
      <button onclick="toggleLabels()">🏷️ Toggle Labels</button>
      <button onclick="changeLayout('breadthfirst')">📊 Vista Jerárquica</button>
      <button onclick="changeLayout('grid')">⚡ Vista Grid</button>
      <button onclick="changeLayout('cose')">🌐 Vista Orgánica</button>
    </div>
    <div class="controls" style="border-top:1px solid #ddd;padding-top:12px;margin-top:-10px;">
      <button onclick="highlightClientSide()">🏢 Edge/Cliente</button>
      <button onclick="highlightCloudSide()">☁️ Cloud/Plataforma</button>
      <button onclick="highlightSecurity()">🔐 Canales Seguros</button>
      <button onclick="airgappedView()">🧱 Vista Air-Gapped</button>
      <button onclick="highlightAdvancedInterfaces()">🚀 Interfaces Avanzadas</button>
    </div>
    <div class="controls" style="border-top:1px solid #ddd;padding-top:12px;margin-top:-10px;background:#f1f8e9;">
      <button onclick="highlightRepositories()" style="background:linear-gradient(135deg,#4caf50 0%,#388e3c 100%)">📦 Ver Todos los Repos</button>
      <button onclick="highlightEdgeRepos()">⚡ Edge Repos</button>
      <button onclick="highlightCloudRepos()">☁️ Cloud Repos</button>
      <button onclick="highlightPlatformRepos()">🛒 Platform Repos</button>
      <button onclick="highlightSharedRepos()">📦 Shared Repos</button>
    </div>
    <div class="controls" style="border-top:1px solid #ddd;padding-top:12px;margin-top:-10px;background:#e3f2fd;">
      <button onclick="showReposDependencies()" style="background:linear-gradient(135deg,#2196f3 0%,#1976d2 100%);font-weight:bold">🗺️ MAPA DE DEPENDENCIAS (24 Repos)</button>
      <button onclick="resetView()">🔙 Vista Normal</button>
    </div>

    <div id="cy"></div>
    
    <div id="repo-tooltip" style="display:none;position:absolute;background:rgba(0,0,0,0.9);color:#fff;padding:12px 16px;border-radius:8px;font-size:12px;max-width:350px;z-index:9999;pointer-events:none;box-shadow:0 4px 12px rgba(0,0,0,0.3);border:2px solid #4caf50;"></div>

    <div class="legend">
      <h3>📖 Leyenda</h3>
      <div class="legend-grid">
        <div class="legend-section">
          <h4>Edge Agents (Cliente)</h4>
          <div class="legend-item"><div class="legend-color" style="background:#8B4513"></div><span>🟤 Zero Agent — Webhooks (API-Key)</span></div>
          <div class="legend-item"><div class="legend-color" style="background:#FFD700"></div><span>🟡 Shared Edge — Multi-tenant (API-Key)</span></div>
          <div class="legend-item"><div class="legend-color" style="background:#32CD32"></div><span>🟢 Edge Lite — Docker (API-Key)</span></div>
          <div class="legend-item"><div class="legend-color" style="background:#1E90FF"></div><span>🔵 Enterprise — K8s (mTLS)</span></div>
          <div class="legend-item"><div class="legend-color" style="background:#DC143C"></div><span>🔴 Air-Gapped — Zero Egress</span></div>
        </div>

        <div class="legend-section">
          <h4>Core en Cliente</h4>
          <div class="legend-item"><div class="legend-color" style="background:#6B46C1"></div><span>NOPS Kernel (Control Plane)</span></div>
          <div class="legend-item"><div class="legend-color" style="background:#C0392B"></div><span>Event Bus (Redis Streams)</span></div>
        </div>

        <div class="legend-section">
          <h4>Plataforma (Cloud/Servicios fuera del Kernel)</h4>
          <div class="legend-item"><div class="legend-color" style="background:#FF8C42"></div><span>Inference Service (Cloud Brain)</span></div>
          <div class="legend-item" style="font-weight:bold;border-left:3px solid #9B59B6;padding-left:8px;margin-left:-8px"><span>7 Módulos NOPS (cloud-core):</span></div>
          <div class="legend-item"><div class="legend-color" style="background:#9B59B6"></div><span>1. Observability Module (37) ✅</span></div>
          <div class="legend-item"><div class="legend-color" style="background:#9B59B6"></div><span>2. Scorecard Module (38) ✅</span></div>
          <div class="legend-item"><div class="legend-color" style="background:#9B59B6"></div><span>3. Billing Module (39) ✅</span></div>
          <div class="legend-item"><div class="legend-color" style="background:#9B59B6"></div><span>4. Sandbox Module (40) ✅</span></div>
          <div class="legend-item"><div class="legend-color" style="background:#9B59B6"></div><span>5. Resource Governance (43) ✅</span></div>
          <div class="legend-item"><div class="legend-color" style="background:#9B59B6"></div><span>6. Lifecycle Module (42) ✅</span></div>
          <div class="legend-item"><div class="legend-color" style="background:#9B59B6"></div><span>7. Compliance Module (41) ✅</span></div>
          <div class="legend-item"><div class="legend-color" style="background:#34495E"></div><span>enis-contracts (Schemas/SDK)</span></div>
        </div>

        <div class="legend-section">
          <h4>Canales y Seguridad</h4>
          <div class="legend-item"><div class="legend-color" style="background:#3498DB"></div><span>API-Key (Agents→Kernel)</span></div>
          <div class="legend-item"><div class="legend-color" style="background:#9B59B6"></div><span>JWT + RBAC (Users→Kernel)</span></div>
          <div class="legend-item"><div class="legend-color" style="background:#E74C3C"></div><span>mTLS + JWT s2s (Kernel↔Cloud)</span></div>
          <div class="legend-item"><div class="legend-color" style="background:#95A5A6"></div><span>Opcional / By-Policy (línea punteada)</span></div>
        </div>

        <div class="legend-section">
          <h4>Marketplace & Apps</h4>
          <div class="legend-item"><div class="legend-color" style="background:#4ECDC4"></div><span>Agent Marketplace (Cloud)</span></div>
          <div class="legend-item"><div class="legend-color" style="background:#16A085"></div><span>Marketplace Connector (Edge)</span></div>
          <div class="legend-item"><div class="legend-color" style="background:#F39C12"></div><span>Studio App (External)</span></div>
        </div>

        <div class="legend-section">
          <h4>Interfaces Avanzadas (S16-S21)</h4>
          <div class="legend-item"><div class="legend-color" style="background:#E67E22"></div><span>🎤 Voice Interface Service (S16) - STT/VAD/TTS</span></div>
          <div class="legend-item"><div class="legend-color" style="background:#8E44AD"></div><span>🥽 XR Interface Service (S17) - Spatial/Gesture</span></div>
          <div class="legend-item"><div class="legend-color" style="background:#27AE60"></div><span>🔌 MCP Gateway (S21) - JSON-RPC</span></div>
          <div class="legend-item"><div class="legend-color" style="background:#2C3E50"></div><span>⛓️ Blockchain Ledger (S20) - Smart Contracts</span></div>
        </div>

        <div class="legend-section">
          <h4>📦 Repositorios SHARED (3)</h4>
          <div class="legend-item"><div class="legend-color" style="background:#607D8B"></div><span>agent-contracts - Schemas/Proto</span></div>
          <div class="legend-item"><div class="legend-color" style="background:#607D8B"></div><span>agent-sdks - Python/Go/TS</span></div>
          <div class="legend-item"><div class="legend-color" style="background:#607D8B"></div><span>enis-infrastructure - IaC/K8s</span></div>
        </div>

        <div class="legend-section">
          <h4>⚡ Repositorios EDGE (3)</h4>
          <div class="legend-item"><div class="legend-color" style="background:#6B46C1"></div><span>nops-kernel - Python 3.11+</span></div>
          <div class="legend-item"><div class="legend-color" style="background:#00BCD4"></div><span>edge-agents - 5 tipos</span></div>
          <div class="legend-item"><div class="legend-color" style="background:#00897B"></div><span>edge-infrastructure - K3s/Docker</span></div>
        </div>

        <div class="legend-section">
          <h4>☁️ Repositorios CLOUD-CORE (7)</h4>
          <div class="legend-item"><div class="legend-color" style="background:#E91E63"></div><span>asm-service - Adaptive State</span></div>
          <div class="legend-item"><div class="legend-color" style="background:#9C27B0"></div><span>cgn-service - Causal Graph</span></div>
          <div class="legend-item"><div class="legend-color" style="background:#3F51B5"></div><span>awe-service - Workflow Evo</span></div>
          <div class="legend-item"><div class="legend-color" style="background:#009688"></div><span>shif-service - Integration</span></div>
          <div class="legend-item"><div class="legend-color" style="background:#FF8C42"></div><span>inference-service - LLM Router</span></div>
          <div class="legend-item"><div class="legend-color" style="background:#E67E22"></div><span>voice-interface-service - Voice Processing</span></div>
          <div class="legend-item"><div class="legend-color" style="background:#8E44AD"></div><span>xr-interface-service - XR Processing</span></div>
        </div>

        <div class="legend-section">
          <h4>🔧 Repositorios CLOUD-OPS (1)</h4>
          <div class="legend-item"><div class="legend-color" style="background:#546E7A"></div><span>cloud-infrastructure - Terraform/Helm</span></div>
        </div>

        <div class="legend-section">
          <h4>🛒 Repositorios PLATFORM (2)</h4>
          <div class="legend-item"><div class="legend-color" style="background:#4ECDC4"></div><span>agent-marketplace - Public/Private</span></div>
          <div class="legend-item"><div class="legend-color" style="background:#F39C12"></div><span>enis-frontend - Next.js</span></div>
        </div>

        <div class="legend-note">
          ⚡ <b>Principio SLIM:</b> El NOPS Kernel mantiene SOLO el core ligero (< 100MB RAM): Agent Registry, Event Bus, Policy Engine, Routing, Security. Los módulos pesados viven en <b>cloud-core/</b> como microservicios independientes.<br/>
          🟣 <b>7 Módulos NOPS (cloud-core) - TODOS DOCUMENTADOS:</b> 1-Observability (37✅), 2-Scorecard (38✅), 3-Billing (39✅), 4-Sandbox (40✅), 5-Resource Governance (43✅), 6-Lifecycle (42✅), 7-Compliance (41✅). Son <b>microservicios independientes en cloud-core/</b>. El kernel usa <b>API clients ligeros</b> con mTLS + JWT s2s (5 clientes: obs, scorecard, billing, sandbox, compliance). El kernel puede operar en <b>degraded mode</b> sin estos servicios (crítico para air-gapped).<br/>
          🚀 <b>Interfaces Avanzadas:</b> Voice Interface Service (S16) y XR Interface Service (S17) son <b>microservicios independientes</b> que se conectan directamente con Inference Service. MCP Gateway (S21) y Blockchain (S20) son extensiones del NOPS Kernel. Todas son opcionales y se activan por feature flags.<br/>
          📦 <b>Repositorios:</b> La arquitectura se divide en <b>24 repositorios independientes</b> organizados en 5 categorías: <b>shared/</b> (3 repos), <b>edge/</b> (3 repos), <b>cloud-core/</b> (15 repos: 5 macro-módulos + 7 módulos NOPS + 2 interfaces avanzadas + 1 governance DGE), <b>cloud-ops/</b> (1 repo), <b>platform/</b> (2 repos). Los repos con bordes punteados "implementan" o "despliegan" los componentes lógicos con bordes sólidos.
        </div>
      </div>
    </div>
  </div>

  <script>
    let cy, labelsVisible = true;

    function initCytoscape(){
      cy = cytoscape({
        container: document.getElementById('cy'),
        style: [
          { selector:'node', style:{
              'label':'data(label)','text-valign':'center','text-halign':'center',
              'background-color':'data(color)','width':'data(size)','height':'data(size)',
              'font-size':'11px','color':'#fff','text-outline-width':1,'text-outline-color':'data(color)',
              'border-width':3,'border-color':'#fff','font-weight':'bold','text-wrap':'wrap','text-max-width':'120px'
          }},
          { selector:'node[layer="client"]', style:{ 'shape':'round-rectangle','background-opacity':.92 } },
          { selector:'node[layer="cloud"]',  style:{ 'shape':'hexagon','background-opacity':.95 } },
          { selector:'node[layer="marketplace"]', style:{ 'shape':'diamond','background-opacity':.9 } },
          { selector:'node[layer="external"]', style:{ 'shape':'ellipse','background-opacity':.88 } },
          { selector:'node[layer="shared"]', style:{ 'shape':'octagon','background-opacity':.92,'border-width':4 } },
          { selector:'node[layer="repo-edge"]', style:{ 'shape':'round-rectangle','background-opacity':.88,'border-style':'dashed' } },
          { selector:'node[layer="repo-cloud"]', style:{ 'shape':'hexagon','background-opacity':.88,'border-style':'dashed' } },
          { selector:'node[layer="repo-ops"]', style:{ 'shape':'round-octagon','background-opacity':.88,'border-style':'dashed' } },
          { selector:'node[layer="repo-platform"]', style:{ 'shape':'diamond','background-opacity':.88,'border-style':'dashed' } },
          { selector:'edge', style:{
              'width':2,'line-color':'data(color)','target-arrow-color':'data(color)','target-arrow-shape':'triangle',
              'curve-style':'bezier','label':'data(label)','font-size':'9px','text-rotation':'autorotate','text-margin-y':-10,'opacity':.9
          }},
          { selector:'edge[security="apikey"]', style:{ 'line-color':'#3498DB','width':2 } },
          { selector:'edge[security="jwt"]',    style:{ 'line-color':'#9B59B6','width':3 } },
          { selector:'edge[security="mtls"]',   style:{ 'line-color':'#E74C3C','width':4 } },
          { selector:'edge[optional="true"]',   style:{ 'line-style':'dashed','opacity':.45 } },
          { selector:'.highlighted', style:{ 'background-color':'#FFD700','border-color':'#FFA500','border-width':5,'z-index':999 } },
          { selector:'.faded', style:{ 'opacity':.15,'text-opacity':0 } },
          { selector:'.security-highlight', style:{ 'border-width':5,'border-color':'#E74C3C','background-blacken':-0.2 } },
          { selector:'edge.security-highlight', style:{ 'width':6,'opacity':1,'line-color':'#E74C3C','target-arrow-color':'#E74C3C','z-index':999 } }
        ],
        elements: {
          nodes: [
            // Edge / Cliente
            { data:{ id:'nops', label:'NOPS Kernel\nControl Plane\nPython 3.11+', layer:'client', color:'#6B46C1', size:120 }, position:{x:500,y:500}},
            { data:{ id:'eventbus', label:'Event Bus\nRedis Streams\nDLQ/Idempotency', layer:'client', color:'#C0392B', size:90 }, position:{x:500,y:350}},
            { data:{ id:'zero', label:'🟤 Zero Agent\nWebhooks', layer:'client', color:'#8B4513', size:80 }, position:{x:200,y:280}},
            { data:{ id:'shared', label:'🟡 Shared Edge\nMulti-tenant', layer:'client', color:'#FFD700', size:80 }, position:{x:200,y:380}},
            { data:{ id:'lite', label:'🟢 Edge Lite\nDocker', layer:'client', color:'#32CD32', size:80 }, position:{x:200,y:480}},
            { data:{ id:'enterprise', label:'🔵 Enterprise\nKubernetes', layer:'client', color:'#1E90FF', size:80 }, position:{x:200,y:580}},
            { data:{ id:'airgapped', label:'🔴 Air-Gapped\nZero Egress', layer:'client', color:'#DC143C', size:80 }, position:{x:200,y:680}},
            { data:{ id:'datasources', label:'Data Sources\nERP/CRM/IoT', layer:'client', color:'#95A5A6', size:90 }, position:{x:500,y:700}},
            { data:{ id:'mp_connector', label:'Marketplace\nConnector\nCache/Mirror', layer:'client', color:'#16A085', size:75 }, position:{x:350,y:570}},
            { data:{ id:'policy', label:'Policy Engine\nABAC/Scopes\nQuotas/Audit', layer:'client', color:'#8E44AD', size:80 }, position:{x:750,y:500}},
            { data:{ id:'eventbridge', label:'Event Bridge\n(Optional)\nKafka/NATS', layer:'client', color:'#2ECC71', size:75 }, position:{x:730,y:350}},

            // Cloud / Plataforma
            { data:{ id:'inference', label:'🧠 Inference\nService\nCloud Brain', layer:'cloud', color:'#FF8C42', size:130 }, position:{x:1100,y:500}},
            { data:{ id:'asm', label:'ASM\nSchema/State', layer:'cloud', color:'#E91E63', size:100 }, position:{x:1400,y:300}},
            { data:{ id:'cgn', label:'CGN\nCausal Graph', layer:'cloud', color:'#9C27B0', size:100 }, position:{x:1400,y:400}},
            { data:{ id:'awe', label:'AWE\nWorkflow Evo', layer:'cloud', color:'#3F51B5', size:100 }, position:{x:1400,y:500}},
            { data:{ id:'shif', label:'SHIF\nIntegration', layer:'cloud', color:'#009688', size:100 }, position:{x:1400,y:600}},

            // Módulos fuera del kernel (cloud-core services - 7 módulos NOPS)
            { data:{ id:'mod_obsv', label:'Observability\nModule', layer:'cloud', color:'#9B59B6', size:90 }, position:{x:1000,y:200}},
            { data:{ id:'mod_score', label:'Scorecard\nModule', layer:'cloud', color:'#9B59B6', size:90 }, position:{x:1150,y:150}},
            { data:{ id:'mod_bill', label:'Billing\nModule', layer:'cloud', color:'#9B59B6', size:90 }, position:{x:1300,y:200}},
            { data:{ id:'mod_sandbox', label:'Sandbox\nModule', layer:'cloud', color:'#9B59B6', size:90 }, position:{x:1250,y:750}},
            { data:{ id:'mod_governance', label:'Resource\nGovernance\nModule', layer:'cloud', color:'#9B59B6', size:90 }, position:{x:750,y:750}},
            { data:{ id:'mod_lifecycle', label:'Lifecycle\nModule', layer:'cloud', color:'#9B59B6', size:90 }, position:{x:950,y:750}},
            { data:{ id:'mod_compliance', label:'Compliance\nModule', layer:'cloud', color:'#9B59B6', size:90 }, position:{x:1100,y:750}},

            // Contratos / SDK
            { data:{ id:'contracts', label:'enis-contracts\nSchemas / SDK', layer:'cloud', color:'#34495E', size:90 }, position:{x:1100,y:350}},

            // Marketplace y Studio
            { data:{ id:'marketplace', label:'Agent Marketplace\n(Cloud)', layer:'marketplace', color:'#4ECDC4', size:100 }, position:{x:1100,y:100}},
            { data:{ id:'private', label:'Private Registry', layer:'marketplace', color:'#5F27CD', size:85 }, position:{x:1300,y:80}},
            { data:{ id:'devportal', label:'Developer Portal', layer:'marketplace', color:'#F7B731', size:85 }, position:{x:900,y:80}},
            { data:{ id:'studio', label:'Studio App\nUI/IDE (External)', layer:'external', color:'#F39C12', size:80 }, position:{x:750,y:780}},
            { data:{ id:'cloudbus', label:'Cloud Bus\nKafka/NATS (opt)', layer:'cloud', color:'#2ECC71', size:75 }, position:{x:900,y:350}},

            // Interfaces Avanzadas (S16-S17)
            { data:{ id:'voice_interface', label:'🎤 Voice Interface Service\nSTT/VAD/TTS\nTTFT <300ms', layer:'cloud', color:'#E67E22', size:100 }, position:{x:1100,y:650}},
            { data:{ id:'xr_interface', label:'🥽 XR Interface Service\nSpatial/Gesture\n30Hz <50ms jitter', layer:'cloud', color:'#8E44AD', size:100 }, position:{x:1100,y:800}},

            // MCP Gateway (S21)
            { data:{ id:'mcp_gateway', label:'🔌 MCP Gateway\nJSON-RPC\nTool Discovery', layer:'client', color:'#27AE60', size:85 }, position:{x:500,y:820}},

            // Blockchain Verifiability (S20)
            { data:{ id:'blockchain_ledger', label:'⛓️ Blockchain\nLedger Integration\nSmart Contracts', layer:'cloud', color:'#2C3E50', size:85 }, position:{x:1400,y:750}},

            // ============ REPOSITORIOS ENIS v3.0 ============
            
            // SHARED (Base común)
            { data:{ id:'repo_contracts', label:'📦 agent-contracts\nSchemas/Proto\nShared', layer:'shared', color:'#607D8B', size:80 }, position:{x:1600,y:150}},
            { data:{ id:'repo_sdks', label:'📦 agent-sdks\nPython/Go/TS\nShared', layer:'shared', color:'#607D8B', size:80 }, position:{x:1600,y:250}},
            { data:{ id:'repo_infra', label:'📦 enis-infrastructure\nIaC/K8s\nShared', layer:'shared', color:'#607D8B', size:80 }, position:{x:1600,y:350}},
            
            // CLOUD-CORE (Servicios principales)
            { data:{ id:'repo_asm', label:'☁️ asm-service\nAdaptive State\nCloud-Core', layer:'repo-cloud', color:'#E91E63', size:85 }, position:{x:1600,y:450}},
            { data:{ id:'repo_cgn', label:'☁️ cgn-service\nCausal Graph\nCloud-Core', layer:'repo-cloud', color:'#9C27B0', size:85 }, position:{x:1600,y:550}},
            { data:{ id:'repo_awe', label:'☁️ awe-service\nWorkflow Evo\nCloud-Core', layer:'repo-cloud', color:'#3F51B5', size:85 }, position:{x:1600,y:650}},
            { data:{ id:'repo_shif', label:'☁️ shif-service\nIntegration\nCloud-Core', layer:'repo-cloud', color:'#009688', size:85 }, position:{x:1600,y:750}},
            { data:{ id:'repo_inference', label:'☁️ inference-service\nLLM Router\nCloud-Core', layer:'repo-cloud', color:'#FF8C42', size:90 }, position:{x:1600,y:850}},
            { data:{ id:'repo_voice', label:'☁️ voice-interface-service\nVoice Processing\nCloud-Core', layer:'repo-cloud', color:'#E67E22', size:85 }, position:{x:1600,y:950}},
            { data:{ id:'repo_xr', label:'☁️ xr-interface-service\nXR Processing\nCloud-Core', layer:'repo-cloud', color:'#8E44AD', size:85 }, position:{x:1600,y:1050}},
            { data:{ id:'repo_dge', label:'🔐 data-governance-service\nDGE - PII/Egress\nCloud-Core', layer:'repo-cloud', color:'#16A085', size:85 }, position:{x:1800,y:500}},
            
            // NOPS Modules (7 repos)
            { data:{ id:'repo_obs', label:'🟣 observability-service\nMetrics/Logs/Traces\nCloud-Core', layer:'repo-cloud', color:'#9B59B6', size:75 }, position:{x:1800,y:150}},
            { data:{ id:'repo_score', label:'🟣 scorecard-service\nAgent Scoring ML\nCloud-Core', layer:'repo-cloud', color:'#9B59B6', size:75 }, position:{x:1800,y:230}},
            { data:{ id:'repo_billing', label:'🟣 billing-service\nMetering/Payments\nCloud-Core', layer:'repo-cloud', color:'#9B59B6', size:75 }, position:{x:1800,y:310}},
            { data:{ id:'repo_sandbox', label:'🟣 sandbox-service\nIsolation/Testing\nCloud-Core', layer:'repo-cloud', color:'#9B59B6', size:75 }, position:{x:1800,y:650}},
            { data:{ id:'repo_compliance', label:'🟣 compliance-service\nAudit/SEC\nCloud-Core', layer:'repo-cloud', color:'#9B59B6', size:75 }, position:{x:1800,y:730}},
            { data:{ id:'repo_rgm', label:'🟣 resource-governance\nFairness/Quotas\nCloud-Core', layer:'repo-cloud', color:'#9B59B6', size:75 }, position:{x:1800,y:810}},
            { data:{ id:'repo_alm', label:'🟣 lifecycle-service\nDeploy/Rollback\nCloud-Core', layer:'repo-cloud', color:'#9B59B6', size:75 }, position:{x:1800,y:890}},
            
            // CLOUD-OPS
            { data:{ id:'repo_cloud_infra', label:'🔧 cloud-infrastructure\nTerraform/Helm\nCloud-Ops', layer:'repo-ops', color:'#546E7A', size:85 }, position:{x:50,y:100}},
            
            // EDGE (Componentes edge)
            { data:{ id:'repo_nops', label:'⚡ nops-kernel\nPython 3.11+\nEdge', layer:'repo-edge', color:'#6B46C1', size:90 }, position:{x:50,y:500}},
            { data:{ id:'repo_edge_agents', label:'⚡ edge-agents\n5 tipos\nEdge', layer:'repo-edge', color:'#00BCD4', size:85 }, position:{x:50,y:400}},
            { data:{ id:'repo_edge_infra', label:'⚡ edge-infrastructure\nK3s/Docker\nEdge', layer:'repo-edge', color:'#00897B', size:85 }, position:{x:50,y:600}},
            
            // PLATFORM
            { data:{ id:'repo_marketplace', label:'🛒 agent-marketplace\nPublic/Private\nPlatform', layer:'repo-platform', color:'#4ECDC4', size:85 }, position:{x:50,y:720}},
            { data:{ id:'repo_frontend', label:'🎨 enis-frontend\nNext.js\nPlatform', layer:'repo-platform', color:'#F39C12', size:85 }, position:{x:50,y:820}}
          ],
          edges: [
            // Agents -> Kernel
            { data:{ source:'zero', target:'nops', label:'API-Key', security:'apikey', color:'#3498DB' } },
            { data:{ source:'shared', target:'nops', label:'API-Key', security:'apikey', color:'#3498DB' } },
            { data:{ source:'lite', target:'nops', label:'API-Key', security:'apikey', color:'#3498DB' } },
            { data:{ source:'enterprise', target:'nops', label:'mTLS', security:'mtls', color:'#E74C3C' } },
            { data:{ source:'airgapped', target:'nops', label:'Local Only', security:'apikey', color:'#DC143C' } },

            // Kernel core
            { data:{ source:'nops', target:'eventbus', label:'pub/sub', security:'internal', color:'#C0392B' } },
            { data:{ source:'datasources', target:'nops', label:'Local Process', security:'internal', color:'#95A5A6' } },

            // Marketplace connector
            { data:{ source:'nops', target:'mp_connector', label:'Registry sync (edge)', security:'internal', color:'#16A085' } },
            { data:{ source:'mp_connector', target:'marketplace', label:'mTLS (marketplace.sync)', security:'mtls', optional:'true', color:'#16A085' } },

            // Policy -> Inference (default)
            { data:{ source:'nops', target:'policy', label:'Decide/Egress', security:'internal', color:'#8E44AD' } },
            { data:{ source:'policy', target:'inference', label:'mTLS + JWT s2s\nmetadata only', security:'mtls', color:'#E74C3C' } },

            // Optional: direct Zero -> Inference
            { data:{ source:'zero', target:'inference', label:'mTLS allowlist (opt)', security:'mtls', optional:'true', color:'#95A5A6' } },

            // Event Bridge (opt)
            { data:{ source:'eventbus', target:'eventbridge', label:'bridge', optional:'true', color:'#2ECC71' } },
            { data:{ source:'eventbridge', target:'cloudbus', label:'mTLS', security:'mtls', optional:'true', color:'#2ECC71' } },

            // Inference -> Macro módulos
            { data:{ source:'inference', target:'asm', label:'schema/state', security:'internal', color:'#FF8C42' } },
            { data:{ source:'inference', target:'cgn', label:'causal', security:'internal', color:'#FF8C42' } },
            { data:{ source:'inference', target:'awe', label:'workflow', security:'internal', color:'#FF8C42' } },
            { data:{ source:'inference', target:'shif', label:'integrations', security:'internal', color:'#FF8C42' } },

            // Contratos / SDK
            { data:{ source:'nops', target:'contracts', label:'client stubs', security:'mtls', optional:'true', color:'#34495E' } },
            { data:{ source:'contracts', target:'mod_obsv', label:'API/Proto', security:'internal', color:'#34495E' } },
            { data:{ source:'contracts', target:'mod_score', label:'API/Proto', security:'internal', color:'#34495E' } },
            { data:{ source:'contracts', target:'mod_bill', label:'API/Proto', security:'internal', color:'#34495E' } },
            { data:{ source:'contracts', target:'mod_sandbox', label:'API/Proto', security:'internal', color:'#34495E' } },
            { data:{ source:'contracts', target:'mod_governance', label:'API/Proto', security:'internal', color:'#34495E' } },
            { data:{ source:'contracts', target:'mod_lifecycle', label:'API/Proto', security:'internal', color:'#34495E' } },
            { data:{ source:'contracts', target:'mod_compliance', label:'API/Proto', security:'internal', color:'#34495E' } },

            // Kernel -> módulos (fuera del kernel) s2s (punteado por política)
            { data:{ source:'nops', target:'mod_obsv', label:'mTLS+JWT s2s', security:'mtls', optional:'true', color:'#9B59B6' } },
            { data:{ source:'nops', target:'mod_score', label:'mTLS+JWT s2s', security:'mtls', optional:'true', color:'#9B59B6' } },
            { data:{ source:'nops', target:'mod_bill', label:'mTLS+JWT s2s', security:'mtls', optional:'true', color:'#9B59B6' } },
            { data:{ source:'nops', target:'mod_sandbox', label:'mTLS+JWT s2s', security:'mtls', optional:'true', color:'#9B59B6' } },
            { data:{ source:'nops', target:'mod_governance', label:'mTLS+JWT s2s', security:'mtls', optional:'true', color:'#9B59B6' } },
            { data:{ source:'nops', target:'mod_lifecycle', label:'mTLS+JWT s2s', security:'mtls', optional:'true', color:'#9B59B6' } },
            { data:{ source:'nops', target:'mod_compliance', label:'mTLS+JWT s2s', security:'mtls', optional:'true', color:'#9B59B6' } },

            // Marketplace (cloud)
            { data:{ source:'inference', target:'marketplace', label:'registry', security:'internal', color:'#4ECDC4' } },
            { data:{ source:'marketplace', target:'private', label:'', security:'internal', color:'#4ECDC4' } },
            { data:{ source:'marketplace', target:'devportal', label:'', security:'internal', color:'#4ECDC4' } },

            // Studio
            { data:{ source:'studio', target:'nops', label:'JWT + RBAC', security:'jwt', color:'#9B59B6' } },
            { data:{ source:'studio', target:'inference', label:'API (opt)', security:'jwt', optional:'true', color:'#F39C12' } },

            // Interfaces Avanzadas (S16-S17)
            { data:{ source:'inference', target:'voice_interface', label:'Voice Engine\nS16', security:'internal', color:'#E67E22' } },
            { data:{ source:'inference', target:'xr_interface', label:'XR Engine\nS17', security:'internal', color:'#8E44AD' } },
            { data:{ source:'voice_interface', target:'studio', label:'Voice Console\nDemo', security:'jwt', optional:'true', color:'#E67E22' } },
            { data:{ source:'xr_interface', target:'studio', label:'XR Panel\nDemo', security:'jwt', optional:'true', color:'#8E44AD' } },

            // MCP Gateway (S21)
            { data:{ source:'nops', target:'mcp_gateway', label:'MCP Server\nS21', security:'internal', color:'#27AE60' } },
            { data:{ source:'mcp_gateway', target:'inference', label:'Tool Discovery\nJSON-RPC', security:'mtls', optional:'true', color:'#27AE60' } },

            // Blockchain Verifiability (S20)
            { data:{ source:'nops', target:'blockchain_ledger', label:'Proof Exchange\nS20', security:'mtls', optional:'true', color:'#2C3E50' } },
            { data:{ source:'blockchain_ledger', target:'mod_compliance', label:'Regulatory\nReporting', security:'internal', color:'#2C3E50' } },

            // ============ REPOSITORIOS -> COMPONENTES LÓGICOS ============
            
            // SHARED repos -> Components
            { data:{ source:'repo_contracts', target:'contracts', label:'define', security:'internal', color:'#607D8B' } },
            { data:{ source:'repo_sdks', target:'contracts', label:'implementa', security:'internal', color:'#607D8B' } },
            { data:{ source:'repo_contracts', target:'nops', label:'schemas', security:'internal', color:'#607D8B', optional:'true' } },
            { data:{ source:'repo_contracts', target:'inference', label:'schemas', security:'internal', color:'#607D8B', optional:'true' } },
            
            // EDGE repos -> Components
            { data:{ source:'repo_nops', target:'nops', label:'implementa', security:'internal', color:'#6B46C1' } },
            { data:{ source:'repo_edge_agents', target:'zero', label:'builds', security:'internal', color:'#00BCD4', optional:'true' } },
            { data:{ source:'repo_edge_agents', target:'shared', label:'builds', security:'internal', color:'#00BCD4', optional:'true' } },
            { data:{ source:'repo_edge_agents', target:'lite', label:'builds', security:'internal', color:'#00BCD4', optional:'true' } },
            { data:{ source:'repo_edge_agents', target:'enterprise', label:'builds', security:'internal', color:'#00BCD4', optional:'true' } },
            { data:{ source:'repo_edge_agents', target:'airgapped', label:'builds', security:'internal', color:'#00BCD4', optional:'true' } },
            { data:{ source:'repo_edge_infra', target:'nops', label:'deploys', security:'internal', color:'#00897B', optional:'true' } },
            
            // CLOUD-CORE repos -> Modules
            { data:{ source:'repo_asm', target:'asm', label:'implementa', security:'internal', color:'#E91E63' } },
            { data:{ source:'repo_cgn', target:'cgn', label:'implementa', security:'internal', color:'#9C27B0' } },
            { data:{ source:'repo_awe', target:'awe', label:'implementa', security:'internal', color:'#3F51B5' } },
            { data:{ source:'repo_shif', target:'shif', label:'implementa', security:'internal', color:'#009688' } },
            { data:{ source:'repo_inference', target:'inference', label:'implementa', security:'internal', color:'#FF8C42' } },
            { data:{ source:'repo_voice', target:'voice_interface', label:'implementa', security:'internal', color:'#E67E22' } },
            { data:{ source:'repo_xr', target:'xr_interface', label:'implementa', security:'internal', color:'#8E44AD' } },
            { data:{ source:'repo_dge', target:'nops', label:'Egress Guard', security:'mtls', color:'#16A085' } },
            { data:{ source:'repo_nops', target:'repo_dge', label:'client', security:'mtls', color:'#16A085' } },
            
            // NOPS Modules -> NOPS Kernel (clients ligeros)
            { data:{ source:'repo_nops', target:'repo_obs', label:'client', security:'mtls', color:'#9B59B6' } },
            { data:{ source:'repo_nops', target:'repo_score', label:'client', security:'mtls', color:'#9B59B6' } },
            { data:{ source:'repo_nops', target:'repo_billing', label:'client', security:'mtls', color:'#9B59B6' } },
            { data:{ source:'repo_nops', target:'repo_sandbox', label:'client', security:'mtls', color:'#9B59B6' } },
            { data:{ source:'repo_nops', target:'repo_compliance', label:'client', security:'mtls', color:'#9B59B6' } },
            { data:{ source:'repo_nops', target:'repo_rgm', label:'optional', security:'mtls', color:'#9B59B6', optional:'true' } },
            { data:{ source:'repo_nops', target:'repo_alm', label:'optional', security:'mtls', color:'#9B59B6', optional:'true' } },
            
            // CLOUD-OPS repo -> Infrastructure
            { data:{ source:'repo_cloud_infra', target:'inference', label:'deploy/ops', security:'internal', color:'#546E7A', optional:'true' } },
            { data:{ source:'repo_cloud_infra', target:'asm', label:'deploy', security:'internal', color:'#546E7A', optional:'true' } },
            { data:{ source:'repo_cloud_infra', target:'cgn', label:'deploy', security:'internal', color:'#546E7A', optional:'true' } },
            { data:{ source:'repo_cloud_infra', target:'awe', label:'deploy', security:'internal', color:'#546E7A', optional:'true' } },
            { data:{ source:'repo_cloud_infra', target:'shif', label:'deploy', security:'internal', color:'#546E7A', optional:'true' } },
            { data:{ source:'repo_cloud_infra', target:'voice_interface', label:'deploy', security:'internal', color:'#546E7A', optional:'true' } },
            { data:{ source:'repo_cloud_infra', target:'xr_interface', label:'deploy', security:'internal', color:'#546E7A', optional:'true' } },
            
            // PLATFORM repos -> Components
            { data:{ source:'repo_marketplace', target:'marketplace', label:'implementa', security:'internal', color:'#4ECDC4' } },
            { data:{ source:'repo_marketplace', target:'private', label:'registry', security:'internal', color:'#4ECDC4' } },
            { data:{ source:'repo_marketplace', target:'devportal', label:'portal', security:'internal', color:'#4ECDC4' } },
            { data:{ source:'repo_frontend', target:'studio', label:'implementa', security:'internal', color:'#F39C12' } },
            
            // Shared infrastructure connections
            { data:{ source:'repo_infra', target:'repo_cloud_infra', label:'extends', security:'internal', color:'#607D8B', optional:'true' } },
            { data:{ source:'repo_infra', target:'repo_edge_infra', label:'extends', security:'internal', color:'#607D8B', optional:'true' } }
          ]
        },
        layout:{ name:'preset', animate:true, animationDuration:900 }
      });

      // Interacción: foco temporal sobre vecindad
      cy.on('tap','node', (evt)=>{
        const node = evt.target;
        const nb = node.neighborhood().add(node);
        cy.elements().removeClass('faded highlighted security-highlight');
        cy.elements().addClass('faded');
        nb.removeClass('faded');
        node.addClass('highlighted');
        setTimeout(()=> cy.elements().removeClass('faded highlighted'), 2500);
      });
    }

    function resetView(){ cy.fit(); cy.center(); cy.elements().removeClass('faded highlighted security-highlight'); }
    function toggleLabels(){
      labelsVisible=!labelsVisible;
      cy.style().selector('node').style({'text-opacity':labelsVisible?1:0}).update();
    }
    function changeLayout(name){
      let opt={name,animate:true,animationDuration:900};
      if(name==='breadthfirst'){ opt.directed=true; opt.roots='#nops'; opt.spacingFactor=2.5; }
      if(name==='grid'){ opt.rows=6; opt.cols=8; }
      if(name==='cose'){ opt={name:'cose',nodeRepulsion:12000,idealEdgeLength:250,edgeElasticity:150,nestingFactor:8,gravity:120,numIter:1200}; }
      cy.layout(opt).run();
    }
    function highlightClientSide(){
      cy.elements().removeClass('highlighted security-highlight');
      cy.elements().addClass('faded');
      cy.nodes('[layer="client"]').removeClass('faded');
      cy.edges('[source="nops"],[target="nops"],[source="eventbus"]').removeClass('faded');
    }
    function highlightCloudSide(){
      cy.elements().removeClass('highlighted security-highlight');
      cy.elements().addClass('faded');
      cy.nodes('[layer="cloud"],[layer="marketplace"]').removeClass('faded');
      cy.edges('[source="inference"],[target="inference"],[source="marketplace"]').removeClass('faded');
    }
    function highlightSecurity(){
      cy.elements().removeClass('highlighted faded');
      cy.elements().addClass('faded');
      cy.edges('[security="mtls"],[security="jwt"]').removeClass('faded').addClass('security-highlight');
      cy.$('#nops,#inference,#policy,#eventbus,#mod_compliance').removeClass('faded').addClass('security-highlight');
    }
    function airgappedView(){
      cy.elements().removeClass('highlighted security-highlight'); cy.elements().addClass('faded');
      cy.nodes('[layer="client"]').removeClass('faded');
      // mantener solo edges internos del cliente
      cy.edges().forEach(e=>{
        const s=e.source().data('layer'), t=e.target().data('layer');
        if(s==='client' && t==='client') e.removeClass('faded');
      });
      cy.$('#airgapped').addClass('highlighted');
    }
    function highlightAdvancedInterfaces(){
      cy.elements().removeClass('highlighted security-highlight');
      cy.elements().addClass('faded');
      cy.$('#voice_interface,#xr_interface,#mcp_gateway,#blockchain_ledger').removeClass('faded').addClass('highlighted');
      cy.$('#inference,#nops').removeClass('faded');
      cy.edges().forEach(e=>{
        const s=e.source().id(), t=e.target().id();
        if((s.includes('voice') || s.includes('xr') || s.includes('mcp') || s.includes('blockchain') || 
            t.includes('voice') || t.includes('xr') || t.includes('mcp') || t.includes('blockchain')) ||
           (s==='inference' && (t.includes('voice') || t.includes('xr'))) ||
           (s==='nops' && (t.includes('mcp') || t.includes('blockchain')))) {
          e.removeClass('faded');
        }
      });
    }

    // ============ FUNCIONES PARA VISUALIZACIÓN DE REPOSITORIOS ============
    
    function highlightRepositories(){
      cy.elements().removeClass('highlighted security-highlight');
      cy.elements().addClass('faded');
      // Mostrar todos los nodos de repositorios
      cy.nodes('[layer="shared"],[layer="repo-edge"],[layer="repo-cloud"],[layer="repo-ops"],[layer="repo-platform"]').removeClass('faded').addClass('highlighted');
      // Mostrar componentes relacionados
      cy.nodes('[layer="client"],[layer="cloud"],[layer="marketplace"]').removeClass('faded');
      // Mostrar edges de implementación
      cy.edges().forEach(e=>{
        const s=e.source().id(), t=e.target().id();
        if(s.startsWith('repo_') || t.startsWith('repo_')) {
          e.removeClass('faded');
        }
      });
    }
    
    function highlightEdgeRepos(){
      cy.elements().removeClass('highlighted security-highlight');
      cy.elements().addClass('faded');
      // Repos edge
      cy.nodes('[layer="repo-edge"]').removeClass('faded').addClass('highlighted');
      // Componentes edge relacionados
      cy.$('#nops,#eventbus,#zero,#shared,#lite,#enterprise,#airgapped').removeClass('faded');
      // Edges relevantes
      cy.edges().forEach(e=>{
        const s=e.source().id(), t=e.target().id();
        if((s==='repo_nops' || s==='repo_edge_agents' || s==='repo_edge_infra') ||
           (t==='repo_nops' || t==='repo_edge_agents' || t==='repo_edge_infra')) {
          e.removeClass('faded');
        }
      });
    }
    
    function highlightCloudRepos(){
      cy.elements().removeClass('highlighted security-highlight');
      cy.elements().addClass('faded');
      // Repos cloud-core
      cy.nodes('[layer="repo-cloud"]').removeClass('faded').addClass('highlighted');
      // Módulos cloud relacionados
      cy.$('#inference,#asm,#cgn,#awe,#shif').removeClass('faded');
      // Edges relevantes
      cy.edges().forEach(e=>{
        const s=e.source().id(), t=e.target().id();
        if(s.startsWith('repo_') && (s.includes('asm')||s.includes('cgn')||s.includes('awe')||s.includes('shif')||s.includes('inference'))) {
          e.removeClass('faded');
        }
      });
    }
    
    function highlightPlatformRepos(){
      cy.elements().removeClass('highlighted security-highlight');
      cy.elements().addClass('faded');
      // Repos platform
      cy.nodes('[layer="repo-platform"]').removeClass('faded').addClass('highlighted');
      // Componentes platform
      cy.$('#marketplace,#private,#devportal,#studio').removeClass('faded');
      // Edges relevantes
      cy.edges().forEach(e=>{
        const s=e.source().id(), t=e.target().id();
        if(s==='repo_marketplace' || s==='repo_frontend' || t==='repo_marketplace' || t==='repo_frontend') {
          e.removeClass('faded');
        }
      });
    }
    
    function highlightSharedRepos(){
      cy.elements().removeClass('highlighted security-highlight');
      cy.elements().addClass('faded');
      // Repos shared
      cy.nodes('[layer="shared"]').removeClass('faded').addClass('highlighted');
      // Componente contracts
      cy.$('#contracts').removeClass('faded');
      // Todos los componentes que usan shared
      cy.$('#nops,#inference').removeClass('faded');
      // Edges relevantes
      cy.edges().forEach(e=>{
        const s=e.source().id(), t=e.target().id();
        if(s.startsWith('repo_') && (s.includes('contracts')||s.includes('sdks')||s.includes('infra'))) {
          e.removeClass('faded');
        }
      });
    }

    // ============ MAPA DE DEPENDENCIAS ENTRE 24 REPOS ============
    const reposDescriptions = {
      // SHARED (3)
      'repo_contracts': {
        name: 'agent-contracts',
        desc: 'Repositorio base que define schemas (Proto, JSON Schema, OpenAPI 3.0) para TODOS los servicios. Sin este repo, ningún servicio puede compilar.',
        category: 'shared',
        connections: 'Depende de nadie. Todos los demás 23 repos dependen de este.'
      },
      'repo_sdks': {
        name: 'agent-sdks',
        desc: 'SDKs oficiales en 5 lenguajes (Python, Go, TypeScript, Java, C#) para que developers construyan agents fácilmente.',
        category: 'shared',
        connections: 'Usado por: edge-agents, enis-frontend'
      },
      'repo_infra': {
        name: 'enis-infrastructure',
        desc: 'Módulos IaC base (Terraform, Helm) compartidos entre edge y cloud para despliegues consistentes.',
        category: 'shared',
        connections: 'Usado por: edge-infrastructure, cloud-infrastructure'
      },
      
      // EDGE (3)
      'repo_nops': {
        name: 'nops-kernel',
        desc: 'Control plane ligero (< 100MB RAM) en el edge. Orquesta agents, maneja eventos, routing, security, y conecta con cloud-core vía mTLS.',
        category: 'edge',
        connections: 'Conecta con: inference (mTLS), 5 NOPS modules (clients), DGE (Egress Guard)'
      },
      'repo_agents': {
        name: 'edge-agents',
        desc: 'Implementación de 5 tipos de agents (Zero🟤, Shared🟡, Lite🟢, Enterprise🔵, Air-Gapped🔴) con diferentes niveles de seguridad y deployment.',
        category: 'edge',
        connections: 'Depende de: agent-contracts (schemas), agent-sdks (clients)'
      },
      'repo_edge_infra': {
        name: 'edge-infrastructure',
        desc: 'Infraestructura para desplegar NOPS Kernel y agents en edge (K3s, Docker, networking). Soporta desde Raspberry Pi hasta Kubernetes.',
        category: 'edge',
        connections: 'Depende de: enis-infrastructure. Despliega: nops-kernel, edge-agents'
      },
      
      // CLOUD-CORE (15)
      'repo_inference': {
        name: 'inference-service',
        desc: 'Router inteligente de LLMs que compone los 4 macro-módulos (ASM/CGN/AWE/SHIF) para generar respuestas. Cerebro de ENIS.',
        category: 'cloud-core',
        connections: 'Conecta con: ASM, CGN, AWE, SHIF (composes). Recibe de: nops-kernel, voice, xr'
      },
      'repo_asm': {
        name: 'asm-service',
        desc: 'Adaptive State Manager: gestiona el estado adaptativo de agents (memoria, contexto, evolución). Uno de los 4 macro-módulos.',
        category: 'cloud-core',
        connections: 'Orquestado por: inference-service'
      },
      'repo_cgn': {
        name: 'cgn-service',
        desc: 'Causal Graph Network: construye grafos causales para razonamiento y toma de decisiones de agents. Macro-módulo de IA avanzada.',
        category: 'cloud-core',
        connections: 'Orquestado por: inference-service'
      },
      'repo_awe': {
        name: 'awe-service',
        desc: 'Agentic Workflow Evolution: evoluciona workflows de agents usando ML y feedback loops. Macro-módulo de automatización.',
        category: 'cloud-core',
        connections: 'Orquestado por: inference-service'
      },
      'repo_shif': {
        name: 'shif-service',
        desc: 'SHared Integration Framework: framework seguro para integraciones con sistemas externos (APIs, webhooks, streaming).',
        category: 'cloud-core',
        connections: 'Orquestado por: inference-service'
      },
      
      // NOPS Modules (7)
      'repo_obs': {
        name: 'observability-service',
        desc: 'Servicio de observabilidad full-stack (Prometheus, Grafana, Jaeger, ELK, Tempo). El NOPS Kernel usa un client ligero para enviar métricas/logs/traces en tiempo real.',
        category: 'cloud-core',
        connections: 'Conectado vía: nops-kernel client (mTLS+JWT). Criticality: ESSENTIAL'
      },
      'repo_score': {
        name: 'scorecard-service',
        desc: 'Scorecard y ML para scoring de agents (performance, calidad, reliability, uptime). Ayuda al routing inteligente y decisiones de fairness.',
        category: 'cloud-core',
        connections: 'Conectado vía: nops-kernel client (mTLS+JWT). Criticality: BEST-EFFORT'
      },
      'repo_billing': {
        name: 'billing-service',
        desc: 'Metering y facturación por uso (API calls, compute, storage, Voice/XR minutes). CRITICAL para revenue protection. NO degradable bajo ninguna circunstancia.',
        category: 'cloud-core',
        connections: 'Conectado vía: nops-kernel client (mTLS+JWT). Criticality: 🔴 CRITICAL (revenue blocker)'
      },
      'repo_sandbox': {
        name: 'sandbox-service',
        desc: 'Entorno aislado para testing de agents antes de producción. Isolation con containers/VMs, límites de recursos, timeout enforcement.',
        category: 'cloud-core',
        connections: 'Conectado vía: nops-kernel client (mTLS+JWT). Criticality: ESSENTIAL'
      },
      'repo_compliance': {
        name: 'compliance-service',
        desc: 'Audit trails inmutables, SEC attestations, compliance reporting (SOC2/ISO 27001/GDPR). CRITICAL para auditorías. NO degradable.',
        category: 'cloud-core',
        connections: 'Conectado vía: nops-kernel client (mTLS+JWT). Criticality: 🔴 CRITICAL (audit trail blocker)'
      },
      'repo_rgm': {
        name: 'resource-governance-service',
        desc: 'Resource Governance Module: fairness multi-tenant, quotas dinámicas, cost optimization, SLA-aware scheduling. Client opcional en Kernel (feature-flag).',
        category: 'cloud-core',
        connections: 'Conectado vía: nops-kernel optional client (mTLS+JWT). Criticality: ESSENTIAL (opcional)'
      },
      'repo_alm': {
        name: 'lifecycle-service',
        desc: 'Agent Lifecycle Manager: deployment, rollback automático, canary, blue-green, gates (SEC + SLOs). Integrado con CI/CD GitOps. Client opcional en Kernel.',
        category: 'cloud-core',
        connections: 'Conectado vía: nops-kernel optional client (mTLS+JWT). Criticality: ESSENTIAL (opcional)'
      },
      
      // Interfaces (2)
      'repo_voice': {
        name: 'voice-interface-service',
        desc: 'Procesamiento de voz en tiempo real (STT, VAD, TTS). TTFT < 300ms, bargein < 100ms. Conecta directo con Inference Service.',
        category: 'cloud-core',
        connections: 'Conecta con: inference-service (WebSocket/SSE). NO conecta con nops-kernel.'
      },
      'repo_xr': {
        name: 'xr-interface-service',
        desc: 'Procesamiento de realidad extendida (OpenXR, spatial mapping, gesture recognition). 30Hz streaming, jitter < 50ms.',
        category: 'cloud-core',
        connections: 'Conecta con: inference-service (WebSocket/SSE). NO conecta con nops-kernel.'
      },
      
      // Governance (1)
      'repo_dge': {
        name: 'data-governance-service',
        desc: 'Data Governance Engine: clasificación PII, redacción automática, egress control (GDPR/CCPA compliance). El Kernel usa un Egress Guard ligero (< 5MB).',
        category: 'cloud-core',
        connections: 'Conectado vía: nops-kernel Egress Guard client. Criticality: CRITICAL (compliance blocker)'
      },
      
      // CLOUD-OPS (1)
      'repo_cloud_infra': {
        name: 'cloud-infrastructure',
        desc: 'Infraestructura K8s, Terraform, ArgoCD, Helm charts. Despliega TODOS los 15 servicios cloud-core. Incluye observability stack, PKI, DR/IR.',
        category: 'cloud-ops',
        connections: 'Despliega: inference, ASM, CGN, AWE, SHIF, 7 NOPS modules, Voice, XR, DGE'
      },
      
      // PLATFORM (2)
      'repo_marketplace': {
        name: 'agent-marketplace',
        desc: 'Marketplace público y privado de agents. Registry, certification, revenue sharing 70/30.',
        category: 'platform',
        connections: 'Depende de: agent-contracts (registry schemas). Conecta con: inference-service'
      },
      'repo_frontend': {
        name: 'enis-frontend',
        desc: 'Studio App (IDE para agents), Dashboard (analytics), Voice/XR interfaces. Built con Next.js + React + Tailwind.',
        category: 'platform',
        connections: 'Depende de: agent-sdks. Conecta con: inference, voice, xr, marketplace'
      }
    };
    
    function showReposDependencies() {
      if (!cy) {
        alert('❌ Error: Cytoscape no inicializado. Recarga la página.');
        return;
      }
      
      cy.nodes().addClass('faded');
      cy.edges().addClass('faded');
      
      // Solo mostrar repos (nodos con layer que empieza con 'repo-')
      const repoNodes = cy.nodes().filter(function(node) {
        const layer = node.data('layer');
        return layer && layer.startsWith('repo');
      });
      
      console.log('📦 Repos encontrados:', repoNodes.length);
      
      repoNodes.removeClass('faded');
      repoNodes.addClass('highlighted');
      
      // Mostrar conexiones entre repos
      let repoEdges = 0;
      cy.edges().forEach(e => {
        const source = e.source();
        const target = e.target();
        const sourceLayer = source.data('layer');
        const targetLayer = target.data('layer');
        
        if (sourceLayer && targetLayer && 
            sourceLayer.startsWith('repo') && targetLayer.startsWith('repo')) {
          e.removeClass('faded');
          repoEdges++;
        }
      });
      
      console.log('🔗 Conexiones entre repos:', repoEdges);
      
      // Cambiar layout para mejor visualización de repos
      const layout = cy.layout({
        name: 'cose',
        directed: true,
        spacingFactor: 2,
        nodeRepulsion: 8000,
        idealEdgeLength: 150,
        edgeElasticity: 100,
        gravity: 0.5,
        numIter: 1000,
        avoidOverlap: true,
        nodeDimensionsIncludeLabels: true,
        animate: true,
        animationDuration: 1000,
        fit: true,
        padding: 60
      });
      layout.run();
      
      // Mostrar mensaje
      setTimeout(function() {
        alert('🗺️ Mapa de Dependencias Activado\n\n✅ Mostrando ' + repoNodes.length + ' repos\n✅ ' + repoEdges + ' conexiones entre repos\n✅ Hover sobre repos para ver descripción\n\n🔙 Click "Reset Vista" para volver');
      }, 1200);
    }
    
    document.addEventListener('DOMContentLoaded', function() {
      initCytoscape();
      
      // Tooltips para repos (hover) - inicializar después de cytoscape
      setTimeout(function() {
        cy.on('mouseover', 'node[layer^="repo"]', function(evt){
          const node = evt.target;
          const nodeId = node.id();
          const repoInfo = reposDescriptions[nodeId];
          
          if (repoInfo) {
            const tooltip = document.getElementById('repo-tooltip');
            tooltip.innerHTML = `
              <div style="border-bottom:1px solid #4caf50;padding-bottom:6px;margin-bottom:8px;font-weight:bold;font-size:14px;">
                📦 ${repoInfo.name}
              </div>
              <div style="margin-bottom:6px;line-height:1.4;">
                ${repoInfo.desc}
              </div>
              <div style="font-size:10px;opacity:0.8;border-top:1px solid rgba(76,175,80,0.3);padding-top:6px;margin-top:6px;">
                <strong>Conexiones:</strong> ${repoInfo.connections}
              </div>
            `;
            tooltip.style.display = 'block';
            tooltip.style.left = (evt.renderedPosition.x + 20) + 'px';
            tooltip.style.top = (evt.renderedPosition.y - 40) + 'px';
          }
        });
        
        cy.on('mouseout', 'node[layer^="repo"]', function(){
          document.getElementById('repo-tooltip').style.display = 'none';
        });
      }, 500);
    });
  </script>
</body>
</html>
